{% for distro in distros %}
{%- set tag = "${CI_REGISTRY_IMAGE}/slurm:${CI_COMMIT_SHORT_SHA}-" + slurm_ver + "-" + distro -%}
{%- set containerfile = distro + "/Containerfile" -%}
build-{{ slurm_ver }}-{{ distro }}-amd64-image:
  stage: build
  timeout: 3h
  retry: 2
  hooks:
    pre_get_sources_script:
      - umask 0022
  image: quay.io/podman/stable:latest
  before_script:
    - podman login -u "${CI_REGISTRY_USER}" -p "${CI_REGISTRY_PASSWORD}" ${CI_REGISTRY}
  script:
{% if GITTAG is defined %}
    - dnf -y install git
    - git -C ${CI_PROJECT_DIR}/slurm fetch --tags
    - git -C ${CI_PROJECT_DIR}/slurm checkout {{ GITTAG }}
{% endif %}
    - ( podman pull {{ tag }}-amd64 ) || ( podman build --squash -f {{ containerfile }} -t {{ tag }}-amd64 . && podman push --retry=5 {{ tag }}-amd64 )

build-{{ slurm_ver }}-{{ distro }}-arm64-image:
  stage: build
  timeout: 3h
  retry: 2
  hooks:
    pre_get_sources_script:
      - umask 0022
  image: quay.io/podman/stable:latest
  before_script:
    - podman login -u "${CI_REGISTRY_USER}" -p "${CI_REGISTRY_PASSWORD}" ${CI_REGISTRY}
  script:
{% if GITTAG is defined %}
    - dnf -y install git
    - git -C ${CI_PROJECT_DIR}/slurm fetch --tags
    - git -C ${CI_PROJECT_DIR}/slurm checkout {{ GITTAG }}
{% endif %}
    - ( podman pull {{ tag }}-arm64 ) || ( podman build --squash -f {{ containerfile }} -t {{ tag }}-arm64 . && podman push --retry=5 {{ tag }}-arm64 )
  tags:
    - saas-linux-small-arm64

tag-{{ slurm_ver }}-{{ distro }}-multi-arch-image:
  stage: build
  timeout: 1h
  retry: 2
  hooks:
    pre_get_sources_script:
      - umask 0022
  image: quay.io/podman/stable:latest
  before_script:
    - podman login -u "${CI_REGISTRY_USER}" -p "${CI_REGISTRY_PASSWORD}" ${CI_REGISTRY}
  script:
    - podman pull {{ tag }}-amd64 {{ tag }}-arm64
    - podman manifest create {{ tag }} {{ tag }}-amd64 {{ tag }}-arm64
    - podman manifest push --all {{ tag }}
  needs:
    - build-{{ slurm_ver }}-{{ distro }}-arm64-image
    - build-{{ slurm_ver }}-{{ distro }}-amd64-image

{% endfor %}
